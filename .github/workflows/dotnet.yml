name: .NET

on:
  workflow_dispatch:
  push:
    branches: main
  pull_request:
    branches: main

env:
  RETENTION_DAYS: 5
  packageVersionPrefix: ${{ '5.0.' }}
  packageVersionSuffixForFeatureBranch: ${{ '-alpha' }}
  packageVersionSuffixForMainBranch: ${{ '-alpha' }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build and test

    steps:
      - uses: actions/checkout@v3
          
      - name: Setup environment variables (main branch)
        if: github.ref == 'refs/heads/main'
        run: echo "packageVersion=${{ env.packageVersionPrefix }}${{ github.run_number }}${{ env.packageVersionSuffixForMainBranch }}" >> $GITHUB_ENV

      - name: Setup environment variables (feature branch)
        if: github.ref != 'refs/heads/main'
        run: echo "packageVersion=${{ env.packageVersionPrefix }}${{ github.run_number }}${{ env.packageVersionSuffixForFeatureBranch }}" >> $GITHUB_ENV

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.x

      - name: Install dotnet global tools (coverlet, reportgenerator)
        run: |
          dotnet tool install --global coverlet.console
          dotnet tool install --global dotnet-reportgenerator-globaltool
          dotnet tool install --global SpecFlow.Plus.LivingDoc.CLI

      - name: Install dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Debug --no-restore

      - name: Test with coverage
        run: dotnet test --no-restore --verbosity normal /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura /p:CoverletOutput='./TestResults/coverage.cobertura.xml'

      - name: Build NuGet package
        run: |
          dotnet pack TestProcessWrapper/TestProcessWrapper.csproj /p:PackageVersion=${{ env.packageVersion }}
          echo "packageVersion=${{ env.packageVersion }}" > TestProcessWrapper/bin/Debug/VERSION.txt

      - name: Test NuGet package
        run: ./smoketest.sh
        working-directory: TestProcessWrapper.Nupkg.Tests
        
      - name: Generate coverage reports
        run: reportgenerator "-reports:TestProcessWrapper.Acceptance.Tests/TestResults/*.xml;TestProcessWrapper.Unit.Tests/TestResults/*.xml" \
          "-targetdir:report" \
          "-reporttypes:Html;lcov" \
          "-title:TestProcessWrapper"
        
      - name: Generate SpecFlow LivingDoc
        run: livingdoc test-assembly TestProcessWrapper.Acceptance.Tests.dll -t TestExecution.json
        working-directory: TestProcessWrapper.Acceptance.Tests/bin/Debug/net7.0

      - name: Attach NuGet package to build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: nuget-package
          path: |
            TestProcessWrapper/bin/Debug/Boos.TestProcessWrapper.${{ env.packageVersion }}.nupkg
            TestProcessWrapper/bin/Debug/VERSION.txt

      - name: Attach coverage reports to build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: report

      - name: Attach LivingDoc to build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: LivingDoc
          path: TestProcessWrapper.Acceptance.Tests/bin/Debug/net7.0/LivingDoc.html

  publish-reports:
    runs-on: ubuntu-latest
    name: Publish coverage reports
    if: github.ref == 'refs/heads/main'
    
    needs: build-and-test
    
    steps:
      # the repository is required by codeclimate-action
      - uses: actions/checkout@v3

      - name: Download coverage reports
        uses: actions/download-artifact@v3
        with:
          name: coverage-reports
          path: coverage-reports
          
      - name: Publish coverage report to coveralls.io
        uses: coverallsapp/github-action@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: coverage-reports/lcov.info

      - name: Publish coverage report to CodeClimate
        uses: paambaati/codeclimate-action@v4.0.0
        env:
          CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}
        with:
          coverageLocations: coverage-reports/lcov.info:lcov

  publish-nuget:
    runs-on: ubuntu-latest
    name: Publish NuGet package
    if: github.ref == 'refs/heads/main'
    
    needs: publish-reports

    steps:
      - name: Download NuGet package
        uses: actions/download-artifact@v3
        with:
          name: nuget-package
          path: nuget-package
          
      - name: Identify package version
        run: cat nuget-package/VERSION.txt >> $GITHUB_ENV

      - name: Publish NuGet package
        run: dotnet nuget push nuget-package/Boos.TestProcessWrapper.${{ env.packageVersion }}.nupkg --api-key ${{ secrets.NUGET_API_ACESS_TOKEN }} --source https://api.nuget.org/v3/index.json
  